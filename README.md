
<div align="center">
    <h1 align="center"><a href="https://github.com/hhftechnology/middleware-manager-traefik">Traefik Middleware Manager</a></h1>
</div>

<h3 align="center">Comprehensive Middleware, Router, and Service Management for Traefik</h3>
<div align="center">
</div>

<div align="center">
  <h5>
    </h5>
</div>

The Traefik Middleware Manager is a specialized microservice that empowers you to attach custom Traefik middlewares to your HTTP/TCP/UDP resources, manage router configurations, define custom Traefik services, and install Traefik pluginsâ€”all through a user-friendly web interface. It provides crucial functionality for implementing authentication, security headers, rate limiting, custom routing logic, and other middleware-based protections with ease.

## Overview

The Middleware Manager monitors resources from your chosen data source (either Pangolin API or a direct Traefik API connection) and provides a web UI to:

* Define and manage custom Traefik middlewares.
* Attach these middlewares to your resources with specific priorities.
* Configure advanced router settings for each resource, including entrypoints, TLS Subject Alternative Names (SANs), TCP SNI routing rules, custom request headers, and router priority.
* Create, update, and delete custom Traefik services (LoadBalancer, Weighted, Mirroring, Failover).
* Assign these custom services to your resources, overriding default service behavior.
* Discover, install, and manage Traefik plugins directly from the UI.

When you make changes, the Middleware Manager generates the necessary Traefik dynamic configuration files, ensuring proper cross-provider references and seamless integration.

## Key Features

* **Dual Data Source Support**: Works with either a Pangolin API or a direct Traefik API.
* **Middleware Management**: Create, update, delete, and assign a wide array of Traefik middlewares.
* **Service Management**: Define and manage custom Traefik services (LoadBalancer, Weighted, Mirroring, Failover) and assign them to resources.
* **Advanced Router Configuration**:
    * Customize HTTP entrypoints.
    * Manage TLS SANs for certificates.
    * Configure TCP SNI routing rules and entrypoints.
    * Set custom request headers for backend services.
    * Adjust router priority for fine-grained control.
* **Plugin Hub**: Discover, install, and manage Traefik plugins.
* **Real-time Synchronization**: Keeps in sync with resources from your selected data source.
* **Web-Based UI**: Intuitive interface for all management tasks.
* **Template Libraries**: Pre-configured templates for common middlewares and services.
* **Cross-Provider Integration**: Correctly references Traefik resources across providers (e.g., `@file`, `@docker`, `@http`).
* **Database Persistence**: Stores all configurations in an SQLite database.
* **Wide Middleware Support**: Includes ForwardAuth, BasicAuth, Headers, RateLimit, IP Whitelisting, Path Manipulation, and more.
* **Dark Mode**: For comfortable viewing in low-light environments.

## Prerequisites

* Docker and Docker Compose
* Traefik v2.x or v3.x (either as part of a Pangolin stack or standalone)
* Network connectivity between the Middleware Manager and your API endpoints (Pangolin or Traefik).

## Quick Start

You can run the Middleware Manager with either Pangolin or a standalone Traefik setup.

### Base `docker-compose.yml` Structure

```yaml
services:
  middleware-manager:
    image: hhftechnology/middleware-manager:v3.0.0 # Or :latest for the stable main branch
    container_name: middleware-manager
    restart: unless-stopped
    volumes:
      - ./data:/data                             # For the SQLite database
      - ./config/traefik/rules:/conf           # For dynamic configuration files generated by Middleware Manager
      - ./config/middleware-manager/templates.yaml:/app/config/templates.yaml # Optional: Custom middleware templates
      - ./config/middleware-manager/templates_services.yaml:/app/config/templates_services.yaml # Optional: Custom service templates
      - ./config/middleware-manager/config.json:/app/config/config.json       # For data source and other persistent settings
      - ./config/traefik:/etc/traefik          # Mount Traefik's static config directory if managing plugins
    ports:
      - "3456:3456"
    networks: # Ensure it's on the same network as Traefik and Pangolin (if used)
      - your_traefik_network 
      # - pangolin_network # If using Pangolin

  # Your Traefik service (example)
  traefik:
    image: traefik:v3.0 # Or your preferred version
    container_name: traefik
    command:
      - "--api.insecure=true" # Required for Middleware Manager to connect
      - "--api.dashboard=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--providers.file.directory=/rules" # Directory for Middleware Manager's generated rules
      - "--providers.file.watch=true"
      # For Plugin Management:
      - "--experimental.plugins.examplePlugin.moduleName=https://github.com/user/example-plugin
      - "--experimental.plugins.examplePlugin.version=vx.y.z"
      # - "--log.level=DEBUG" # For troubleshooting
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080" # Traefik API/Dashboard
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./config/traefik/traefik.yml:/traefik.yml # Traefik static config (if managing plugins)
      - ./config/traefik/rules:/rules         # Must match TRAEFIK_CONF_DIR for Middleware Manager rules
      - ./config/letsencrypt:/letsencrypt
    networks:
      - your_traefik_network

networks:
  your_traefik_network:
    # driver: bridge # or specify existing external network
  # pangolin_network:
    # external: true
````

### Environment Variables for Middleware Manager

| Variable                      | Description                                                                 | Default                                                                                      |
| ----------------------------- | --------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------- |
| `PANGOLIN_API_URL`            | URL to your Pangolin API (if using Pangolin mode)                         | `http://pangolin:3001/api/v1`                                                                  |
| `TRAEFIK_API_URL`             | URL to your Traefik API                                                     | `http://host.docker.internal:8080` (tries auto-discovery if empty)                           |
| `TRAEFIK_CONF_DIR`            | Directory inside Middleware Manager to write Traefik dynamic configs        | `/conf`                                                                                      |
| `DB_PATH`                     | Path to SQLite database inside the container                                | `/data/middleware.db`                                                                        |
| `PORT`                        | Port for Middleware Manager web UI and API                                    | `3456`                                                                                       |
| `CONFIG_DIR`                  | Directory for Middleware Manager's internal config files (templates, etc.)    | `/app/config`                                                                                |
| `ACTIVE_DATA_SOURCE`          | Initial data source: `pangolin` or `traefik`                                | `pangolin`                                                                                   |
| `TRAEFIK_STATIC_CONFIG_PATH`  | Path to Traefik's main static config file (e.g., `traefik.yml`)             | `/etc/traefik/traefik.yml`                                                                   |
| `PLUGINS_JSON_URL`            | URL to fetch the list of available Traefik plugins                          | `https://raw.githubusercontent.com/hhftechnology/middleware-manager/traefik-int/plugin/plugins.json` |
| `CHECK_INTERVAL_SECONDS`      | How often to check for new resources (seconds)                              | `30`                                                                                         |
| `SERVICE_INTERVAL_SECONDS`    | How often to check for new services (seconds)                             | `30`                                                                                         |
| `GENERATE_INTERVAL_SECONDS`   | How often to update Traefik dynamic configuration files (seconds)           | `10`                                                                                         |
| `DEBUG`                       | Enable debug logging                                                        | `false`                                                                                      |
| `ALLOW_CORS`                  | Enable CORS for API                                                         | `false`                                                                                      |
| `CORS_ORIGIN`                 | Allowed CORS origin (if `ALLOW_CORS` is true; empty means allow all)        | `""`                                                                                         |

### 1\. Using with Pangolin (Default Mode)

Set `ACTIVE_DATA_SOURCE=pangolin` (or leave it as default) and configure `PANGOLIN_API_URL`.

```yaml
# In middleware-manager service definition:
services:
  middleware-manager:
    # ... other config ...
    environment:
      - PANGOLIN_API_URL=http://pangolin_container_name:3001/api/v1 # Adjust if needed
      - TRAEFIK_API_URL=http://traefik_container_name:8080         # Still useful for some operations
      - TRAEFIK_CONF_DIR=/conf
      - DB_PATH=/data/middleware.db
      - PORT=3456
      - ACTIVE_DATA_SOURCE=pangolin
      - TRAEFIK_STATIC_CONFIG_PATH=/etc/traefik/traefik.yml # Path inside Traefik container, for plugin management
      - PLUGINS_JSON_URL=[https://raw.githubusercontent.com/hhftechnology/middleware-manager/traefik-int/plugin/plugins.json](https://raw.githubusercontent.com/hhftechnology/middleware-manager/traefik-int/plugin/plugins.json)
    # ... volumes and ports ...
```

### 2\. Using with Standalone Traefik (Without Pangolin)

Set `ACTIVE_DATA_SOURCE=traefik` and configure `TRAEFIK_API_URL`.

```yaml
# In middleware-manager service definition:
services:
  middleware-manager:
    # ... other config ...
    environment:
      - TRAEFIK_API_URL=http://traefik_container_name:8080 # Ensure this matches your Traefik API
      - TRAEFIK_CONF_DIR=/conf
      - DB_PATH=/data/middleware.db
      - PORT=3456
      - ACTIVE_DATA_SOURCE=traefik
      - TRAEFIK_STATIC_CONFIG_PATH=/etc/traefik/traefik.yml # Path inside Traefik container, for plugin management
      - PLUGINS_JSON_URL=[https://raw.githubusercontent.com/hhftechnology/middleware-manager/traefik-int/plugin/plugins.json](https://raw.githubusercontent.com/hhftechnology/middleware-manager/traefik-int/plugin/plugins.json)
    # ... volumes and ports ...
```

You can also manage data source settings via `config.json` (see "Data Source Configuration" below).

After configuring, start the services: `docker-compose up -d`
Access the UI at `http://your-server-ip:3456`.

## Configuration Details

### Data Source Configuration (`config.json`)

The Middleware Manager can connect to either Pangolin or Traefik as a data source for discovering resources. You can configure this via the `config.json` file, which will be created by default in the path specified by the `CONFIG_DIR` environment variable (inside the container, e.g., `/app/config/config.json`). Mount a volume to this path to persist your settings.

Example `config.json`:

```json
{
  "active_data_source": "traefik",
  "data_sources": {
    "pangolin": {
      "type": "pangolin",
      "url": "http://pangolin:3001/api/v1",
      "basic_auth": {
        "username": "",
        "password": ""
      }
    },
    "traefik": {
      "type": "traefik",
      "url": "http://traefik:8080",
      "basic_auth": {
        "username": "",
        "password": ""
      }
    }
  }
}
```

You can switch the `active_data_source` and update URLs/credentials through the **Settings** panel in the UI.

### Custom Templates

  * **Middleware Templates**: Create `templates.yaml` in your mapped `CONFIG_DIR` (e.g., `./config/middleware-manager/templates.yaml`).
    ```yaml
    middlewares:
      - id: "my-custom-headers"
        name: "My Strong Security Headers"
        type: "headers"
        config:
          browserXssFilter: true
          contentTypeNosniff: true
          # ... other header options
    ```
  * **Service Templates**: Create `templates_services.yaml` in your mapped `CONFIG_DIR` (e.g., `./config/middleware-manager/templates_services.yaml`).
    ```yaml
    services:
      - id: "my-custom-lb"
        name: "My Custom Load Balancer"
        type: "loadBalancer"
        config:
          servers:
            - url: "http://mybackend1:8000"
            - url: "http://mybackend2:8000"
          healthCheck:
            path: "/healthz"
            interval: "5s"
    ```

## Usage Guide

### Dashboard

The dashboard provides an at-a-glance overview of your resources, middlewares, services, and their protection status.

### Managing Resources

1.  Navigate to the **Resources** tab.
2.  Resources are automatically discovered from your active data source (Pangolin or Traefik).
3.  Click **Manage** next to a resource to configure it.
4.  **Advanced Router Configuration**:
      * **HTTP Entrypoints**: Click the button to specify which Traefik entrypoints this HTTP router should listen on (e.g., `web`, `websecure`). Comma-separated. Default: `websecure`.
      * **TLS Domains**: Click to add Subject Alternative Names (SANs) for the TLS certificate. The primary host is automatically included. Comma-separated.
      * **TCP Routing**: Click to enable and configure TCP SNI routing. Specify TCP entrypoints and the SNI matching rule (e.g., `HostSNI(\`https://www.google.com/search?q=your-tcp-host.example.com\`)\`).
      * **Custom Headers**: Click to define custom request headers that Traefik will add to requests forwarded to this resource's backend service. Useful for setting `Host` headers or other custom values.
      * **Router Priority**: Adjust the numerical priority of the router. Higher numbers are evaluated first by Traefik. Default: `100`.
5.  **Assigning Middlewares**:
      * In the "Attached Middlewares" section, click **Add Middleware**.
      * Select one or more middlewares from the list of available (unassigned) middlewares.
      * Set a **Priority** (higher numbers run first, e.g., an auth middleware should have a higher priority than a headers middleware).
      * Click **Assign Selected**.
6.  **Assigning a Custom Service**:
      * In the "Service Configuration" section, the default service (usually from Docker or Pangolin) is shown.
      * Click **Assign Custom Service** (or **Change Assigned Service**).
      * Select a service from the list of services you've defined in the "Services" tab.
      * Click **Assign Service**. This will make the resource's router use your custom Traefik service definition.
      * To revert to the default service, remove the custom assignment.

### Managing Middlewares

1.  Navigate to the **Middlewares** tab.
2.  View existing middlewares or click **Create Middleware**.
3.  Provide a **Name**, select a **Type** (e.g., `headers`, `basicAuth`, `rateLimit`, `plugin`).
4.  Configure the middleware using the JSON editor. Templates are provided for common types.
      * For `chain` middlewares, select other existing middlewares to include in the chain.
      * For `plugin` middlewares, ensure the plugin is declared in your Traefik static configuration. The config key here should match the plugin's name as defined in Traefik (e.g., if plugin is `crowdsec`, the key in JSON would be `"crowdsec": { ...plugin_config... }`).
5.  Click **Create Middleware** or **Update Middleware**.

### Managing Services

1.  Navigate to the **Services** tab.
2.  View existing services or click **Create Service**.
3.  Provide a **Name** (e.g., `my-app-blue-green`). This name will be used for referencing (e.g., `my-app-blue-green@file`).
4.  Select a **Type**:
      * `loadBalancer`: Distributes requests among multiple backend servers.
          * **Protocol**: Choose HTTP, TCP, or UDP for the backend servers.
          * `servers`: Define backend servers with `url` (for HTTP) or `address` (for TCP/UDP). Can include `weight`.
          * `healthCheck`: Configure health checks for servers.
          * `sticky`: Configure session stickiness (e.g., cookie-based).
      * `weighted`: Distributes requests across multiple other *named* services based on weights.
          * `services`: List of `{ "name": "service-id@provider", "weight": 2 }`.
      * `mirroring`: Sends requests to a primary service and mirrors a percentage of traffic to other services.
          * `service`: The primary service ID (e.g., `main-production@file`).
          * `mirrors`: List of `{ "name": "analytics-mirror@file", "percent": 10 }`.
      * `failover`: Routes to a primary service, falling back to another if the primary fails.
          * `service`: The main service ID.
          * `fallback`: The fallback service ID.
5.  Configure the service options using the JSON editor. Templates and help text are provided.
6.  Click **Create Service** or **Update Service**.

### Managing Plugins (Plugin Hub)

1.  Navigate to the **Plugin Hub** tab.
2.  **Set Traefik Static Configuration Path**:
      * Input the **absolute path** to your main Traefik static configuration file (e.g., `/etc/traefik/traefik.yml` or `/data/traefik.yml`) *as it exists inside the Middleware Manager container*. This path must be volume-mounted from your host to be accessible by Middleware Manager.
      * **Important**: For this setting to persist across Middleware Manager restarts, set the `TRAEFIK_STATIC_CONFIG_PATH` environment variable for the Middleware Manager container. Setting it in the UI is temporary for the current session.
3.  Browse or search for available plugins.
4.  For each plugin:
      * Specify the **Version** you want to install (e.g., `v1.2.3`). If left blank, it usually defaults to the latest recommended by the plugin source.
      * Click **Install Plugin**. This action modifies your Traefik static configuration file to declare the plugin under the `experimental.plugins` section.
      * To remove a plugin, click **Remove Plugin**.
5.  **Restart Traefik**: After installing or removing plugins, you **must restart your Traefik container** for the changes to take effect and for the plugin to be loaded/unloaded.
6.  Once a plugin is installed and Traefik is restarted, you can create a middleware of type `plugin` and configure it. The configuration key in the JSON editor should match the plugin's name (e.g., if you installed a plugin named `myawesomeplugin` in `traefik.yml`, your middleware config would be `{"myawesomeplugin": { /* plugin-specific options */ }}`).

Example of how Middleware Manager adds a plugin to `traefik.yml`:

```yaml
# In your traefik.yml (or equivalent)
experimental:
  plugins:
    statiq: # This key is derived from the moduleName
      moduleName: [github.com/hhftechnology/statiq](https://github.com/hhftechnology/statiq)
      version: v0.3.0
    crowdsecbouncer: # Another example
      moduleName: [github.com/maxlerebourg/crowdsec-bouncer-traefik-plugin](https://github.com/maxlerebourg/crowdsec-bouncer-traefik-plugin)
      version: v1.4.2
# ... other Traefik static configurations ...
```

## Troubleshooting

### Connection Issues

  * **Container Naming**: For Docker, use container names (e.g., `http://traefik:8080`, `http://pangolin:3001/api/v1`) not `localhost`.
  * **Traefik API**: Ensure Traefik API is enabled (`--api.insecure=true`).
  * **Networking**: Verify containers are on the same Docker network.
  * `curl` Tests:
      * `docker exec <middleware_manager_container_name> curl http://pangolin_container_name:3001/api/v1/traefik-config`
      * `docker exec <middleware_manager_container_name> curl http://traefik_container_name:8080/api/http/routers`

### "The service does not exist" or "The middleware does not exist" in Traefik

  * **Provider Suffixes**: Middleware Manager generally handles this. Manually created services/middlewares in the UI are typically from the `@file` provider. Services/middlewares from the data source (Docker, Pangolin) will have their respective providers (e.g., `@docker`, `@http`).
  * **Generated Files**: Check `resource-overrides.yml` in your mapped `/conf` directory for correctness.
  * **Plugin Not Loaded**: If it's a plugin middleware, ensure the plugin is correctly declared in Traefik's static config and Traefik has been restarted.

### Service Templates Not Loading

  * Ensure `templates_services.yaml` is correctly volume-mounted to `/app/config/templates_services.yaml` inside the container.
  * Verify the YAML syntax in your `templates_services.yaml` file is correct.
  * Check Middleware Manager logs for errors during template loading.

## Development

### Prerequisites

  * Go (version as per `go.mod`)
  * Node.js (version as per `ui/package.json` engines, or latest LTS)
  * npm or yarn

### Backend

```bash
# Navigate to the project root
go run main.go # For development with auto-restart, consider tools like air
# For build:
go build -o middleware-manager main.go
```

### Frontend

```bash
cd ui
npm install # or yarn install
npm start   # or yarn start
```

The UI will be available at `http://localhost:3000` and will proxy API requests to the Go backend (defaulting to `http://localhost:3456` as per `ui/package.json` proxy setting).

## License

MIT License

## Contributing

Contributions, issues, and feature requests are welcome\! Please feel free to submit a Pull Request or open an issue.


